name: install-nvidia-driver

description: |
  Idempotent workflow to install NVIDIA driver on a node.
  - Uses Java plugin for reliable hung apt detection - skips if found
  - If nvidia-smi is already available, does nothing (no upgrade)
  - If not installed, installs nvidia-driver-535
  Requires: export SUDO_PASSWORD="your-password" before running.

steps:
  - states: ["0", "1"]
    note: Load plugin JAR
    actions:
      - actor: loader
        method: loadJar
        arguments: ["../actor-IaC-plugins/target/actor-IaC-plugins-1.0.0.jar"]

  - states: ["1", "2"]
    note: Load AptLockChecker plugin
    actions:
      - actor: loader
        method: createChild
        arguments: ["this", "aptChecker", "com.scivicslab.actoriac.plugins.aptcheck.AptLockChecker"]

  - states: ["2", "3"]
    note: Get hostname
    actions:
      - actor: this
        method: executeCommand
        arguments: ["hostname -s"]

  - states: ["3", "4"]
    note: Store hostname
    actions:
      - actor: this
        method: putJson
        arguments:
          path: hostname
          value: "${result}"

  - states: ["4", "5"]
    note: Get process list
    actions:
      - actor: this
        method: executeCommand
        arguments: ["ps -eo pid,etimes,args 2>/dev/null"]

  - states: ["5", "6"]
    note: Check for hung apt processes
    actions:
      - actor: aptChecker
        method: check
        arguments:
          psOutput: "${result}"
          hostname: "${json.hostname}"

  - states: ["6", "7"]
    note: Store hung status and skip if hung
    actions:
      - actor: this
        method: executeCommand
        arguments:
          - |
            HOSTNAME=$(hostname -s)
            RESULT='${result}'
            if echo "$RESULT" | grep -q "^HUNG:"; then
                # Extract PID and age from HUNG:pid:age format
                PID=$(echo "$RESULT" | sed 's/HUNG:\([0-9]*\):.*/\1/')
                AGE=$(echo "$RESULT" | sed 's/HUNG:[0-9]*:\(.*\)/\1/')
                echo "%$HOSTNAME: [SKIP] APT_HUNG ($AGE) PID=$PID"
                echo "SKIP_REASON=APT_HUNG"
            else
                echo "SKIP_REASON=none"
            fi

  - states: ["7", "8"]
    note: Store skip reason
    actions:
      - actor: this
        method: putJson
        arguments:
          path: skipReason
          value: "${result}"

  - states: ["8", "9"]
    note: Check if nvidia-smi is already installed
    actions:
      - actor: this
        method: executeCommand
        arguments:
          - |
            HOSTNAME=$(hostname -s)
            SKIP='${json.skipReason}'

            # Skip if apt hung was detected (preserve skip reason for next step)
            if echo "$SKIP" | grep -q "APT_HUNG"; then
                echo "SKIP_REASON=APT_HUNG"
                exit 0
            fi

            if command -v nvidia-smi &> /dev/null; then
                echo "NVIDIA_DRIVER_INSTALLED=true"
                VERSION=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null || echo "unknown")
                echo "%$HOSTNAME: [OK] nvidia-smi already installed (driver $VERSION)"
                echo "SKIP_REASON=ALREADY_INSTALLED"
                exit 0
            fi

            # Check if this node has NVIDIA GPU
            if ! lspci | grep -qi nvidia; then
                echo "NVIDIA_DRIVER_INSTALLED=n/a"
                echo "%$HOSTNAME: [SKIP] No NVIDIA GPU"
                echo "SKIP_REASON=NO_GPU"
                exit 0
            fi

            # Check if user has sudo access by actually trying sudo
            SUDO_CHECK=$(timeout 1 sudo -S true < /dev/null 2>&1)
            if echo "$SUDO_CHECK" | grep -q "not in the sudoers"; then
                echo "%$HOSTNAME: [SKIP] No sudo access"
                echo "SKIP_REASON=NO_SUDO_ACCESS"
                exit 0
            fi

            echo "NVIDIA GPU found, will install driver"
            echo "SKIP_REASON=none"

  - states: ["9", "10"]
    note: Update skip reason
    actions:
      - actor: this
        method: putJson
        arguments:
          path: skipReason
          value: "${result}"

  # --- Stage 1: Add PPA (2-step pattern) ---
  - states: ["10", "11"]
    note: Check if should add PPA
    actions:
      - actor: this
        method: executeCommand
        arguments:
          - |
            SKIP='${json.skipReason}'
            if ! echo "$SKIP" | grep -q "SKIP_REASON=none"; then
                echo "SKIPPED"
            else
                echo "PROCEED"
            fi

  - states: ["11", "12"]
    note: Wait for apt lock and add PPA (only if PROCEED)
    actions:
      - actor: this
        method: executeSudoCommand
        arguments:
          - |
            PREV='${result}'
            if [ "$PREV" = "SKIPPED" ]; then
                exit 0
            fi

            HOSTNAME=$(hostname -s)

            # Wait for apt lock (max 5 min)
            TIMEOUT=300
            ELAPSED=0
            while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                    echo "TIMEOUT waiting for apt lock"
                    echo "%$HOSTNAME: [FAIL] apt lock timeout"
                    exit 1
                fi
                echo "Waiting for apt lock... (${ELAPSED}s)"
                sleep 10
                ELAPSED=$((ELAPSED + 10))
            done

            add-apt-repository ppa:graphics-drivers/ppa -y && apt update

  # --- Stage 2: Install driver (2-step pattern) ---
  - states: ["12", "13"]
    note: Check if should install driver
    actions:
      - actor: this
        method: executeCommand
        arguments:
          - |
            SKIP='${json.skipReason}'
            if ! echo "$SKIP" | grep -q "SKIP_REASON=none"; then
                echo "SKIPPED"
            else
                echo "PROCEED"
            fi

  - states: ["13", "14"]
    note: Install NVIDIA driver (only if PROCEED)
    actions:
      - actor: this
        method: executeSudoCommand
        arguments:
          - |
            PREV='${result}'
            if [ "$PREV" = "SKIPPED" ]; then
                exit 0
            fi

            HOSTNAME=$(hostname -s)

            # Wait for apt lock (max 5 min)
            TIMEOUT=300
            ELAPSED=0
            while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                    echo "TIMEOUT waiting for apt lock"
                    echo "%$HOSTNAME: [FAIL] apt lock timeout"
                    exit 1
                fi
                echo "Waiting for apt lock... (${ELAPSED}s)"
                sleep 10
                ELAPSED=$((ELAPSED + 10))
            done

            apt install -y nvidia-driver-535

  # --- Verification ---
  - states: ["14", "end"]
    note: Verification
    actions:
      - actor: this
        method: executeCommand
        arguments:
          - |
            HOSTNAME=$(hostname -s)
            SKIP='${json.skipReason}'

            # Skip verification if skipped earlier
            if ! echo "$SKIP" | grep -q "SKIP_REASON=none"; then
                exit 0
            fi

            if command -v nvidia-smi &> /dev/null; then
                VERSION=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null || echo "unknown")
                echo "%$HOSTNAME: [INSTALLED] nvidia-driver (driver $VERSION)"
            else
                if lspci | grep -qi nvidia; then
                    echo "%$HOSTNAME: [PENDING] reboot required"
                fi
            fi
