name: main-install-gpu-drivers

description: |
  Idempotent workflow to install GPU drivers on all compute nodes.
  - Checks for hung apt processes first - skips affected nodes
  - NVIDIA nodes: installs nvidia-driver-535 (if not already installed)
  - AMD nodes: installs ROCm 6.0 (if not already installed)
  - Already installed: does nothing (no upgrade)

  Can be safely run against all compute nodes - skips nodes without GPU
  or with drivers already installed.

steps:
  - states: ["0", "1"]
    note: Load WorkflowReporter
    actions:
      - actor: loader
        method: createChild
        arguments: ["ROOT", "workflowReporter", "com.scivicslab.actoriac.WorkflowReporter"]

  - states: ["1", "2"]
    note: Output workflow info to report
    actions:
      - actor: workflowReporter
        method: addWorkflowInfo

  - states: ["2", "3"]
    note: Install NVIDIA drivers (idempotent)
    actions:
      - actor: nodeGroup
        method: apply
        arguments:
          actor: "node-*"
          method: runWorkflow
          arguments: ["gpu-setup/install-nvidia-driver.yaml"]

  - states: ["3", "4"]
    note: Install ROCm (idempotent)
    actions:
      - actor: nodeGroup
        method: apply
        arguments:
          actor: "node-*"
          method: runWorkflow
          arguments: ["gpu-setup/install-rocm.yaml"]

  - states: ["4", "end"]
    note: Generate report
    actions:
      - actor: workflowReporter
        method: report

  - states: ["!end", "end"]
    note: Generate report even on error
    actions:
      - actor: workflowReporter
        method: report
