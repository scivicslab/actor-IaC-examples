name: detect-apt-lock

description: |
  Read-only workflow to detect apt lock status using Java plugin.
  Checks for hung apt processes (running > 1 hour).

steps:
  - states: ["0", "1"]
    note: Load plugin JAR
    actions:
      - actor: loader
        method: loadJar
        arguments: ["../actor-IaC-plugins/target/actor-IaC-plugins-1.0.0.jar"]

  - states: ["1", "2"]
    note: Load AptLockChecker plugin
    actions:
      - actor: loader
        method: createChild
        arguments: ["this", "aptChecker", "com.scivicslab.actoriac.plugins.aptcheck.AptLockChecker"]

  - states: ["2", "3"]
    note: Get hostname
    actions:
      - actor: this
        method: executeCommand
        arguments: ["hostname -s"]

  - states: ["3", "4"]
    note: Store hostname
    actions:
      - actor: this
        method: putJson
        arguments:
          path: hostname
          value: "${result}"

  - states: ["4", "5"]
    note: Get process list
    actions:
      - actor: this
        method: executeCommand
        arguments: ["ps -eo pid,etimes,args 2>/dev/null"]

  - states: ["5", "6"]
    note: Check for hung apt processes
    actions:
      - actor: aptChecker
        method: check
        arguments:
          psOutput: "${result}"
          hostname: "${json.hostname}"

  - states: ["6", "7"]
    note: Store check result
    actions:
      - actor: this
        method: putJson
        arguments:
          path: checkResult
          value: "${result}"

  - states: ["7", "end"]
    note: Output result for WorkflowReporter (via SSH for log capture)
    actions:
      - actor: this
        method: executeCommand
        arguments:
          - |
            HOSTNAME='${json.hostname}'
            RESULT='${json.checkResult}'
            if echo "$RESULT" | grep -q "^HUNG:"; then
                PID=$(echo "$RESULT" | cut -d: -f2)
                AGE=$(echo "$RESULT" | cut -d: -f3)
                echo "%$HOSTNAME: [CRITICAL] HUNG ($AGE) PID=$PID"
            else
                echo "%$HOSTNAME: [OK] UNLOCKED"
            fi
